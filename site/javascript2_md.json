{"body":"<h2 id=\"javascript-load-order\">Javascript Load Order</h2>\n<p>As per <a href=\"https://api.drupal.org/api/drupal/includes%21common.inc/function/drupal_add_js/7.x\">https://api.drupal.org/api/drupal/includes%21common.inc/function/drupal_add_js/7.x</a> - <strong>The exact ordering of JavaScript is as follows</strong></p>\n<p>#####Load Order</p>\n<ul>\n<li>First by scope, with &#39;header&#39; first, &#39;footer&#39; last, and any other scopes provided by a custom theme coming in between, as determined by the theme.</li>\n<li>Then by group.</li>\n<li>Then by the &#39;every_page&#39; flag, with TRUE coming before FALSE.</li>\n<li>Then by weight.</li>\n<li>Then by the order in which the JavaScript was added. For example, all else being the same, JavaScript added by a call to drupal_add_js() that happened later in the page request gets added to the page after one for which drupal_add_js() happened earlier in the page request.</li>\n</ul>\n<p><strong>The load order of Javascript is the same unaggregated and aggregated.</strong></p>\n<p>#####Execution Order</p>\n<p>Within the load order:</p>\n<ul>\n<li>Javascript that is inside an IIFE will execute first</li>\n<li>Javascript inside Drupal.behaviours will execute next</li>\n<li>Javascript inside $(document).ready() will execute last</li>\n</ul>\n<p>#####Simulated Load &amp; Execution Order</p>\n<ul>\n<li>libraries added using drupal_add_library() from within a module</li>\n<li>autodesk_jstest.module - array(&#39;group&#39; =&gt; -100, &#39;scope&#39; =&gt; &#39;header&#39;, &#39;every_page&#39; =&gt; TRUE, &#39;type&#39; =&gt; &#39;file&#39;, ) - IFFE</li>\n<li>autodesk_jstest.info - IFFE</li>\n<li>autodesk_jstest.module - array(&#39;group&#39; =&gt; 0, &#39;scope&#39; =&gt; &#39;header&#39;, &#39;every_page&#39; =&gt; TRUE, &#39;type&#39; =&gt; &#39;file&#39;, ) - IFFE</li>\n<li>template.php - IFFE</li>\n<li>autodesk_foundation5.info - IFFE</li>\n<li>autodesk_jstest.module - array(&#39;group&#39; =&gt; -100, &#39;scope&#39; =&gt; &#39;footer&#39;, &#39;every_page&#39; =&gt; TRUE, &#39;type&#39; =&gt; &#39;file&#39;, ) - IFFE</li>\n<li>autodesk_jstest.module - array(&#39;group&#39; =&gt; 0, &#39;scope&#39; =&gt; &#39;footer&#39;, &#39;every_page&#39; =&gt; TRUE, &#39;type&#39; =&gt; &#39;file&#39;, ) - IFFE</li>\n<li>autodesk_jstest.module - array(&#39;group&#39; =&gt; -100, &#39;scope&#39; =&gt; &#39;header&#39;, &#39;every_page&#39; =&gt; TRUE, &#39;type&#39; =&gt; &#39;file&#39;, )  - Drupal.Behaviour</li>\n<li>autodesk_jstest.info - Drupal.Behaviour</li>\n<li>autodesk_jstest.module - array(&#39;group&#39; =&gt; 0, &#39;scope&#39; =&gt; &#39;header&#39;, &#39;every_page&#39; =&gt; TRUE, &#39;type&#39; =&gt; &#39;file&#39;, )  - Drupal.Behaviour</li>\n<li>template.php - Drupal.Behaviour</li>\n<li>autodesk_foundation5.info - Drupal.Behaviour</li>\n<li>autodesk_jstest.module - array(&#39;group&#39; =&gt; -100, &#39;scope&#39; =&gt; &#39;footer&#39;, &#39;every_page&#39; =&gt; TRUE, &#39;type&#39; =&gt; &#39;file&#39;, )  - Drupal.Behaviour</li>\n<li>autodesk_jstest.module - array(&#39;group&#39; =&gt; 0, &#39;scope&#39; =&gt; &#39;footer&#39;, &#39;every_page&#39; =&gt; TRUE, &#39;type&#39; =&gt; &#39;file&#39;, )  - Drupal.Behaviour</li>\n<li>autodesk_jstest.module - array(&#39;group&#39; =&gt; -100, &#39;scope&#39; =&gt; &#39;header&#39;, &#39;every_page&#39; =&gt; TRUE, &#39;type&#39; =&gt; &#39;file&#39;, ) - $(document).ready()</li>\n<li>autodesk_jstest.info - $(document).ready()</li>\n<li>autodesk_jstest.module - array(&#39;group&#39; =&gt; 0, &#39;scope&#39; =&gt; &#39;header&#39;, &#39;every_page&#39; =&gt; TRUE, &#39;type&#39; =&gt; &#39;file&#39;, ) - $(document).ready()</li>\n<li>template.php - $(document).ready()</li>\n<li>autodesk_foundation5.info - $(document).ready()</li>\n<li>autodesk_jstest.module - array(&#39;group&#39; =&gt; -100, &#39;scope&#39; =&gt; &#39;footer&#39;, &#39;every_page&#39; =&gt; TRUE, &#39;type&#39; =&gt; &#39;file&#39;, ) - $(document).ready()</li>\n<li>autodesk_jstest.module - array(&#39;group&#39; =&gt; 0, &#39;scope&#39; =&gt; &#39;footer&#39;, &#39;every_page&#39; =&gt; TRUE, &#39;type&#39; =&gt; &#39;file&#39;, ) - $(document).ready()</li>\n</ul>\n<p>#####.info and template.php</p>\n<ul>\n<li>Javascript loaded via Module .info files is added to (&#39;scope&#39; =&gt; &#39;header&#39;,  &#39;group&#39; =&gt; 0, &#39;every_page&#39; =&gt; TRUE)</li>\n<li>Javascript loaded via the Theme .info file is added to (&#39;scope&#39; =&gt; &#39;header&#39;, &#39;group&#39; =&gt; 100, &#39;every_page&#39; =&gt; TRUE)</li>\n<li>Javascript loaded inside the template.php hook_preprocess_html() is added to (&#39;scope&#39; =&gt; &#39;header&#39;, &#39;group&#39; =&gt; 0, &#39;every_page&#39; =&gt; FALSE&#39;) - <strong>but it is added on EVERY PAGE</strong> - You should explicity set &#39;every_page&#39; =&gt; TRUE or load the javascript in a different file</li>\n</ul>\n<h5 id=\"hook_init-\">hook_init()</h5>\n<ul>\n<li>Javascript loaded inside of a Modules hook_init() is added to (&#39;scope&#39; =&gt; &#39;header&#39;, &#39;group&#39; =&gt; 0, &#39;every_page&#39; =&gt; FALSE) - <strong>but it is added on EVERY PAGE</strong> - You should explicity set &#39;every_page&#39; =&gt; TRUE or load the javascript file in another function.</li>\n</ul>\n<h2 id=\"javascript-aggregation\">Javascript Aggregation</h2>\n<p><a href=\"https://www.lullabot.com/articles/javascript-aggregation-in-drupal-7\">https://www.lullabot.com/articles/javascript-aggregation-in-drupal-7</a></p>\n<p>Let’s take a close look at the parameters affecting Javascript aggregation. <strong>Drupal will create an aggregate for each unique combination of the scope, group, and every_page parameters</strong>, so it’s important to understand what each of these mean.</p>\n<p>It is possible to see how files are aggregated with the following code. Note dsm() requires devel.</p>\n<pre><code class=\"lang-php\">// include/common.inc\n// drupal_get_js()&#39;\n// add the code at line 4478\n    if ($item[&#39;every_page&#39;]) {$every_page = &quot;every-page&quot;;} else {$every_page = &quot;not-every-page&quot;;}\n    $key = &#39;aggregate_&#39; . $item[&#39;group&#39;] . &#39;_&#39; . $item[&#39;scope&#39;] . &#39;_&#39; . $every_page . &#39;_&#39; . $index;      \n// add the code below to line 4512\n    dsm($key);\n    dsm($uri);\n    dsm($files[$key]);\n</code></pre>\n<p>####Aggregation Grouping\n<strong>Drupal will create an aggregate for each unique combination of the scope, group, and every_page parameters</strong></p>\n<ul>\n<li>group: -100, every_page: true, scope: header, preprocess: true</li>\n<li>group: -100, every_page: false, scope: header, preprocess: true</li>\n<li>group: 0, every_page: true, scope: header, preprocess: true</li>\n<li>group: 0, every_page: false, scope: header, preprocess: true</li>\n<li>group: 100, every_page: true, scope: header, preprocess: true</li>\n<li>group: 0, every_page: false, scope: footer, preprocess: true</li>\n</ul>\n<h2 id=\"drupal-settings-is-undefined\">Drupal.settings Is Undefined</h2>\n<p>The Drupal.settings object is only available to Javascript wrapped in $(document).ready() or inside a Drupal behaviour. </p>\n<p>If you wish to access Drupal.settings inside an anonymous function or IFFE, you can include the Drupal object earlier in the bootstrap by using</p>\n<pre><code class=\"lang-javascript\">(function(jQuery, Drupal) {\n    log.debug(Drupal.settings);\n})(jQuery, Drupal);\n</code></pre>\n<h2 id=\"tips-to-achieve-optimal-javascript\">Tips To Achieve Optimal Javascript</h2>\n<p>####Load Javascript files in a way that allows them to be aggregated by Drupal aggregation</p>\n<ul>\n<li>Files added using drupal_add_js(&#39;/js/filename.js&#39;, array(&#39;type&#39; =&gt; &#39;external&#39;) will not be aggregated</li>\n<li>Files added inline in template files using \\<script\\> will not be aggregated</li>\n<li>If drupal_add_js(&#39;preprocess&#39; =&gt; false) is set, the file will not be aggregated</li>\n</ul>\n<p>A good way to identify non-aggregated files is to turn on Drupal aggregation and load a page in Chrome. Goto the &quot;sources&quot; panel </p>\n<p><img src=\"sources.png\" alt=\"Chrome Dev Tools Sources Panel\"></p>\n<p>####Optimize Aggregation</p>\n<p>Try to load the javascript file into the optimal aggregated file based on your load order needs and if the file needs to be used on every page (or almost every page) or if it is only needed on a few pages.</p>\n<p>####Where possible, only load Javascript files when the module is &quot;active&quot;</p>\n<ul>\n<li>Calling drupal_add_js() inside of hook_init() will load the file on every page, even if the module is &quot;inactive&quot;. It will be added to &quot;_group: 0, every_page: false, scope: header, preprocess: true_&quot;</li>\n<li>Javascript files included in the modules .info file will load on every page, even if the module is &quot;inactive&quot;</li>\n</ul>\n<p>####Try not to include different versions (or filenames) of the same file, across modules</p>\n<p>####Remove Javascript files which are no longer used</p>\n<p>####Javascript which is not related to a module or is largely generic, consider moving into scripts.js as a Drupal.behavior</p>\n<h2 id=\"double-loading\">Double Loading</h2>\n<ul>\n<li>Prevent double execution of Drupal.behaviours. Modify the function call to Drupal.attachBehaviours in the “was this helpful&quot; module.</li>\n</ul>\n<pre><code class=\"lang-php\">// modules/custom/autodesk_search_feedback/templates/autodesk_search_feedback.tpl.php\n    - Drupal.attachBehaviors(&#39;#search-helpful-id&#39;, Drupal.settings);\n    + Drupal.behaviors.analytics.attach();\n</code></pre>\n<pre><code class=\"lang-php\">// modules/custom/autodesk_helpful/template/autodesk_helpful.tpl.php \n    - Drupal.attachBehaviors(&#39;#helpful-article&#39;, Drupal.settings);\n    + Drupal.behaviors.analytics.attach();\n</code></pre>\n<ul>\n<li>In scripts.js - add the .once() method to code that manipulates the DOM on CAAS pages.</li>\n</ul>\n<pre><code class=\"lang-php\">// js/app/scripts.js\n + $(&#39;.caas_dt_body_text&#39;).once().prepend(&quot;&lt;h2&gt;Description&lt;/h2&gt;&quot;);\n</code></pre>\n<h2 id=\"clean-up-themes-js-folder\">Clean Up Themes /js/ Folder</h2>\n<ul>\n<li>Modify the /js/ as per the following table</li>\n<li>Added log.info() to all behaviors and js in custom modules, this helps to visualize load order.</li>\n<li><em>loglevel.js</em>, <em>js-cookie.js</em> and <em>foundation.min.js</em> should be loaded first. This fixes intermittent undefined function errors from .log() and .foundation()</li>\n</ul>\n<pre><code class=\"lang-php\"> // template.php\n // function autodesk_preprocess_html() {\n     drupal_add_js(\n         &quot;sites/all/modules/custom/autodesk_faceted_search/js autodesk_faceted_search.validate.js&quot;,\n        array(&#39;type&#39; =&gt; &#39;file&#39;, &#39;scope&#39; =&gt; &#39;header&#39;, &#39;group&#39; =&gt; &#39;JS_LIBRARY&#39;));\n</code></pre>\n<p><strong>Some Javascript in the /js/ folder could be moved into modules</strong></p>\n<ul>\n<li>Move js/akn_mlt/akn_mlt.js into modules/custom/adsk_related_links/ module. This module must be renamed to autodesk_related_links to evade adblocking</li>\n<li>Turn akn_header_search.app.js into a Drupal module and a block</li>\n</ul>\n<h2 id=\"remove-javascript-from-zurb_foundation\">Remove Javascript From zurb_foundation</h2>\n<ul>\n<li>;scripts[] = js/vendor/modernizr.js</li>\n<li>;scripts[] = js/foundation.js</li>\n</ul>\n<h2 id=\"jquery-update\">jQuery Update</h2>\n<p>Attempt to use only 1 version of jQuery.</p>\n<ul>\n<li>Change jquery-update module jQuery version from 1.7 -&gt; 1.9</li>\n<li>Change jquery-update module jQuery admin version to 1.7. jquery-update allows a separate version of jQuery to be set for the admin theme. the admin “seven” theme requires 1.7 or less.</li>\n<li>Update depreciated methods for 2 functions so they are compatible with jQuery 1.9</li>\n</ul>\n<hr>\n<ul>\n<li>Disable jqmulti module - this module is required by:<ul>\n<li>(Adblock Fix) Autodesk Pluck Integration </li>\n<li>Autodesk Topic Article Feature, </li>\n<li>ADSK Products (Taxonomy), </li>\n<li>ADSK Download Content Type, </li>\n<li>Autodesk Taxonomy Sync, </li>\n<li>CAAS Context Feature, </li>\n<li>Autodesk Simple Content Type, </li>\n<li>Autodesk Collections Content Type, </li>\n<li>Autodesk GPS Widget</li>\n</ul>\n</li>\n<li>Remove jqmulti dependancies from features and module .info files</li>\n<li>Find and replace references to jq190 -&gt; jQuery</li>\n</ul>\n<hr>\n<ul>\n<li>index_refresh.php loads jquery and jscookie directly - Could we load these files from CDN? <ul>\n<li>sites/all/libraries/jquery/jquery-1.9.0.min.js</li>\n<li>sites/all/themes/autodesk_foundation5/js/vendor/js-cookie.min.js</li>\n</ul>\n</li>\n</ul>\n<h2 id=\"drupal-libraries\">Drupal Libraries</h2>\n<p>There are couple of ways to define a library in Drupal. </p>\n<ol>\n<li>The Drupal Core Library system (used for managing and loading shared libraries of JS &amp; CSS) which is accessed by hook_library() and drupal_get_library()</li>\n<li>The <a href=\"http://www.drupalcontrib.org/api/drupal/contributions%21libraries%21libraries.module/7\">Libraries contrib module</a> accessed by hook_libraries_info() &amp;  libraries_load()</li>\n</ol>\n<h4 id=\"print-active-drupal-core-libraries-to-the-page-inside-the-messages-block-\">Print active Drupal Core Libraries to the page (inside the messages block)</h4>\n<pre><code class=\"lang-php\">// template.php\n// preprocess_html() \n// display available libraries\n    $module_libraries =  module_list();\n    $test = [];\n    foreach ($module_libraries as $key =&gt; $data) {\n        $test += (drupal_get_library($data));\n    }\n    dsm($test);\n</code></pre>\n<h4 id=\"use-a-contrib-module-library-wrapper-for-the-library\">Use a contrib module library wrapper for the library</h4>\n<p>For example: <a href=\"https://www.drupal.org/project/backbone\">Drupal Backbone</a> - <em>Unfortunately library wrappers often contain outdated versions of the Javascript library, or include bloated and unnecessary additional features</em></p>\n<h4 id=\"create-your-own-drupal-library-wrapper-using-hook-_library-\">Create your own Drupal library wrapper using hook_library()</h4>\n<pre><code class=\"lang-php\">// autodesk_loglevel.module\n\n/**\n * Implements hook_library().\n */\nfunction autodesk_loglevel_library() {\n  // Library One.\n  $libraries[&#39;loglevel&#39;] = array(\n    &#39;title&#39; =&gt; &#39;Log Level&#39;,\n    &#39;website&#39; =&gt; &#39;http://example.com/library-1&#39;,\n    &#39;version&#39; =&gt; &#39;1.2&#39;,\n    &#39;js&#39; =&gt; array(\n      drupal_get_path(&#39;theme&#39;, &#39;autodesk_foundation5&#39;) . &#39;/js/vendor/loglevel.js&#39; =&gt; array(),\n    )\n  );\n  return $libraries;\n}\n</code></pre>\n<pre><code class=\"lang-php\">// Loading the library from another module for example - autodesk_translation.module\n    drupal_add_library(&#39;autodesk_loglevel&#39;,&#39;loglevel&#39;);\n</code></pre>\n<h5 id=\"create-a-library-using-the-libraries-contrib-module\">Create a library using the libraries contrib module</h5>\n<p><a href=\"http://atendesigngroup.com/blog/adding-js-libraries-drupal-project-libraries-api\">http://atendesigngroup.com/blog/adding-js-libraries-drupal-project-libraries-api</a></p>\n<h2 id=\"line-by-line\">Line by Line</h2>\n<ul>\n<li>autodesk_contributions.modules loads //code.jquery.com/ui/1.11.4/jquery-ui.min.js&#39; - jQuery UI 1.10.2 is included with jquery_update.</li>\n</ul>\n<pre><code class=\"lang-php\">     //  drupal_add_js ( &#39;//code.jquery.com/ui/1.10.2/jquery-ui.min.js&#39;, array (\n    //      &#39;type&#39; =&gt; &#39;external&#39;,\n    //      &#39;scope&#39; =&gt; &#39;footer&#39;\n    //  ) );\n      drupal_add_library(&#39;system&#39;,&#39;ui.mouse&#39;);\n      drupal_add_library(&#39;system&#39;,&#39;ui.sortable&#39;);\n</code></pre>\n<ul>\n<li>adsk_caas/adsk_caas.js should be moved to scripts.js as a Drupal.behavior</li>\n<li>adsk_lithium<ul>\n<li>drupal_add_js(drupal_get_path(&#39;module&#39;, &#39;adsk_lithium&#39;) . &#39;/js/underscore.js&#39;);</li>\n<li>Looks like the underscore library is being used in lithium_contactus_block_theme.tpl.php line 159</li>\n</ul>\n</li>\n<li>autodesk_translation.module<ul>\n<li>this module is loading javascript files using &#39;type&#39; =&gt; &#39;external&#39; so they are not being aggregated in production</li>\n</ul>\n</li>\n</ul>\n","updatedAt":"2016-07-01T22:08:28.000Z"}